<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تتبع GPS - Firebase</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* البطاقات */
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* الخريطة */
        #map { height: 500px; width: 100%; border-radius: 10px; z-index: 1; }
        
        /* لوحة البيانات */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: linear-gradient(135deg, #3498db, #2c3e50); color: white; padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 1.8em; font-weight: bold; margin: 5px 0; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        
        /* الحالة */
        .status-bar { text-align: center; margin-bottom: 20px; }
        .status-badge { padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }

        footer { text-align: center; margin-top: 20px; color: #777; }
    </style>
</head>
<body>

<div class="container">
    <div class="status-bar">
        <h1><i class="fas fa-satellite-dish"></i> تتبع المركبة المباشر</h1>
        <span id="connection-status" class="status-badge disconnected">جاري الاتصال...</span>
    </div>

    <div class="dashboard">
        <div class="stat-box">
            <i class="fas fa-tachometer-alt"></i>
            <div class="stat-value" id="speed">0</div>
            <div class="stat-label">السرعة (كم/س)</div>
        </div>
        <div class="stat-box">
            <i class="fas fa-map-marker-alt"></i>
            <div class="stat-value" id="lat">--</div>
            <div class="stat-label">خط العرض</div>
        </div>
        <div class="stat-box">
            <i class="fas fa-map-marker-alt"></i>
            <div class="stat-value" id="lng">--</div>
            <div class="stat-label">خط الطول</div>
        </div>
        <div class="stat-box">
            <i class="fas fa-satellite"></i>
            <div class="stat-value" id="sats">0</div>
            <div class="stat-label">الأقمار</div>
        </div>
    </div>

    <div class="card">
        <div id="map"></div>
    </div>
    
    <footer>
        <p>يعمل بواسطة ESP32 و Firebase Realtime Database</p>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
    // 1. استيراد دوال Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // 2. إعدادات Firebase الخاصة بك
    const firebaseConfig = {
        databaseURL: "https://gps-tracker-534ae-default-rtdb.firebaseio.com/"
    };

    // 3. تهيئة التطبيق
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 4. إعداد الخريطة
    const map = L.map('map').setView([33.309772, 44.421445], 13);
    
    // إضافة طبقة الخريطة (شوارع)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // أيقونة السيارة
    const carIcon = L.divIcon({
        html: '<div style="font-size: 24px; color: #e74c3c;"><i class="fas fa-car-side"></i></div>',
        className: 'custom-div-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    let marker = L.marker([33.309772, 44.421445], {icon: carIcon}).addTo(map);
    let pathLine = L.polyline([], {color: 'blue'}).addTo(map);
    let pathPoints = [];

    // 5. الاستماع للبيانات من Firebase
    const gpsRef = ref(db, 'gps');
    
    onValue(gpsRef, (snapshot) => {
        const data = snapshot.val();
        const statusBadge = document.getElementById('connection-status');
        
        if (data) {
            // تحديث حالة الاتصال
            statusBadge.textContent = "متصل بالمركبة";
            statusBadge.className = "status-badge connected";

            // التحقق من صحة الإشارة
            if (data.valid === true || data.valid === "true") {
                const lat = parseFloat(data.lat);
                const lng = parseFloat(data.lng);
                
                // تحديث النصوص
                document.getElementById('speed').textContent = data.speed ? parseFloat(data.speed).toFixed(1) : 0;
                document.getElementById('lat').textContent = lat.toFixed(5);
                document.getElementById('lng').textContent = lng.toFixed(5);
                document.getElementById('sats').textContent = data.sats || 0;

                // تحديث الخريطة
                const newLatLng = [lat, lng];
                marker.setLatLng(newLatLng);
                map.setView(newLatLng); // تحريك الكاميرا مع السيارة

                // رسم المسار
                pathPoints.push(newLatLng);
                pathLine.setLatLngs(pathPoints);
            } else {
                statusBadge.textContent = "انتظار إشارة GPS...";
                statusBadge.className = "status-badge disconnected";
            }
        }
    });
</script>

</body>
</html>
