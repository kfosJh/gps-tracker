<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التتبع الذكي | Smart GPS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #00f260;
            --secondary-color: #0575E6;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Tajawal', sans-serif;
            color: var(--text-color);
            background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364, #1a2a6c);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 1s ease-in-out;
        }

        /* --- Header Section --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            padding: 15px 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        h1 { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        
        .status-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .connected { background: rgba(0, 255, 127, 0.2); color: #00ff7f; border: 1px solid #00ff7f; }
        .connected .status-dot { background-color: #00ff7f; animation: pulse 1.5s infinite; }
        
        .disconnected { background: rgba(255, 99, 71, 0.2); color: #ff6347; border: 1px solid #ff6347; }
        .disconnected .status-dot { background-color: #ff6347; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 127, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 127, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 127, 0); }
        }

        /* --- Grid Layout --- */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
        }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        /* --- Info Cards --- */
        .info-panel {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (max-width: 900px) {
            .info-panel { grid-template-columns: repeat(2, 1fr); }
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .icon-box {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(255,255,255,0.1);
        }

        .card-content { display: flex; flex-direction: column; }
        .card-label { font-size: 0.8rem; opacity: 0.8; }
        .card-value { font-size: 1.4rem; font-weight: bold; margin-top: 2px; }
        .unit { font-size: 0.8rem; margin-right: 5px; }

        /* --- Map Section --- */
        .map-wrapper {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 10px;
            height: 600px;
            position: relative;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            z-index: 1;
        }

        .map-overlay-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: #fff;
            color: #333;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .control-btn:hover { background: #f0f0f0; }

        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1><i class="fas fa-satellite"></i> نظام التتبع الذكي</h1>
            <div id="status-box" class="status-pill disconnected">
                <div class="status-dot"></div>
                <span id="status-text">جاري البحث...</span>
            </div>
        </header>

        <div class="main-grid">
            <div class="info-panel">
                
                <div class="card">
                    <div class="icon-box" style="color: #4facfe; background: rgba(79, 172, 254, 0.2);">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">السرعة الحالية</span>
                        <div class="card-value"><span id="speed">0</span> <span class="unit">كم/س</span></div>
                    </div>
                </div>

                <div class="card">
                    <div class="icon-box" style="color: #f6d365; background: rgba(246, 211, 101, 0.2);">
                        <i class="fas fa-satellite"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">الأقمار المتصلة</span>
                        <div class="card-value"><span id="sats">0</span></div>
                    </div>
                </div>

                <div class="card">
                    <div class="icon-box" style="color: #ff9a9e; background: rgba(255, 154, 158, 0.2);">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">خط العرض (Lat)</span>
                        <div class="card-value" id="lat" style="font-size: 1.1rem;">--.---</div>
                    </div>
                </div>

                <div class="card">
                    <div class="icon-box" style="color: #a18cd1; background: rgba(161, 140, 209, 0.2);">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">خط الطول (Lng)</span>
                        <div class="card-value" id="lng" style="font-size: 1.1rem;">--.---</div>
                    </div>
                </div>

                 <div class="card">
                    <div class="icon-box" style="color: #84fab0; background: rgba(132, 250, 176, 0.2);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="card-content">
                        <span class="card-label">آخر تحديث</span>
                        <div class="card-value" id="last-time" style="font-size: 1rem;">--:--:--</div>
                    </div>
                </div>

            </div>

            <div class="map-wrapper">
                <div class="map-overlay-controls">
                    <button class="control-btn" onclick="clearPath()"><i class="fas fa-eraser"></i> مسح المسار</button>
                    <button class="control-btn" onclick="centerMap()"><i class="fas fa-crosshairs"></i> مركزي</button>
                </div>
                <div id="map"></div>
            </div>
        </div>

        <footer>
            Ahmed Engineer Project &copy; 2026 | IoT & GPS Tracking System
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // إعدادات Firebase الخاصة بك
        const firebaseConfig = {
            databaseURL: "https://gps-tracker-534ae-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // تهيئة الخريطة
        const map = L.map('map').setView([33.309772, 44.421445], 15);

        // طبقة خريطة بتصميم داكن قليلاً (CartoDB Dark Matter) ليتناسب مع الثيم، أو العادي
        // يمكنك استبدال الرابط بـ OpenStreetMap العادي إذا فضلت الألوان الفاتحة
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // أيقونة السيارة المخصصة
        const carIcon = L.divIcon({
            html: `<div style="
                background: #0575E6;
                width: 30px; height: 30px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 0 15px rgba(5, 117, 230, 0.6);
                display: flex; justify-content: center; align-items: center;
                color: white;">
                <i class="fas fa-car" style="font-size: 14px;"></i>
            </div>`,
            className: 'custom-car-marker',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        let marker = L.marker([33.309772, 44.421445], {icon: carIcon}).addTo(map);
        let pathLine = L.polyline([], {color: '#0575E6', weight: 4, opacity: 0.8}).addTo(map);
        let pathPoints = [];

        // متغيرات للتحكم
        let isFirstLoad = true;

        // دالة الاستماع للبيانات
        const gpsRef = ref(db, 'gps');
        onValue(gpsRef, (snapshot) => {
            const data = snapshot.val();
            const statusBox = document.getElementById('status-box');
            const statusText = document.getElementById('status-text');

            if (data) {
                // تحديث الحالة
                statusBox.className = "status-pill connected";
                statusText.innerText = "متصل بالمركبة";

                // التحقق من صحة GPS
                if(data.valid === true || data.valid === "true") {
                    const lat = parseFloat(data.lat);
                    const lng = parseFloat(data.lng);
                    const speed = data.speed ? parseFloat(data.speed).toFixed(1) : 0;
                    const sats = data.sats || 0;
                    
                    // تحديث النصوص في البطاقات
                    updateElement('speed', speed);
                    updateElement('sats', sats);
                    document.getElementById('lat').innerText = lat.toFixed(6);
                    document.getElementById('lng').innerText = lng.toFixed(6);
                    
                    if(data.time) {
                        document.getElementById('last-time').innerText = data.time;
                    }

                    // تحديث الخريطة
                    const newLatLng = [lat, lng];
                    marker.setLatLng(newLatLng);

                    // إضافة للمسار
                    pathPoints.push(newLatLng);
                    pathLine.setLatLngs(pathPoints);

                    // تحريك الكاميرا في أول مرة فقط أو إذا خرجت السيارة عن الشاشة
                    if (isFirstLoad) {
                        map.setView(newLatLng, 16);
                        isFirstLoad = false;
                    }
                } else {
                    // إذا كان متصل بالنت لكن لا يوجد GPS
                    statusText.innerText = "بحث عن إشارة GPS...";
                    statusBox.style.borderColor = "#f6d365";
                    statusBox.style.color = "#f6d365";
                    document.querySelector('.status-dot').style.backgroundColor = "#f6d365";
                }
            }
        });

        // دالة مساعدة لتحديث الأرقام بتأثير بسيط
        function updateElement(id, newValue) {
            const el = document.getElementById(id);
            if(el.innerText !== newValue) {
                el.innerText = newValue;
                el.style.color = "#00f260"; // وميض أخضر
                setTimeout(() => el.style.color = "", 500);
            }
        }

        // دوال التحكم اليدوي (Global Scope)
        window.clearPath = function() {
            pathPoints = [];
            pathLine.setLatLngs([]);
        }

        window.centerMap = function() {
            if(marker) {
                map.setView(marker.getLatLng(), 16);
            }
        }
    </script>
</body>
</html>
